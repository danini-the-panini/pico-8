pico-8 cartridge // http://www.pico-8.com
version 38
__lua__
score=0
flapping=false
wing=0
game_over=false
t=0
dt=0.03
bird_x=56
bird_y=60
gravity=0.3
vx=2
vy=0
jump=3.5
ground_x=0

pipe_time=30*4
pipe_gap=40
pipe_width=32
pipes={}

function _init()
end

function restart()
  score=0
  flapping=false
  wing=0
  game_over=false
  bird_y=60
  vy=0

  pipe_time=30*4
  pipes={}
end

function update_bird_gravity()
  vy+=gravity
  bird_y+=vy
  if bird_y>106 then
    bird_y=106
  end
end

function flap()
  vy=-jump
  sfx(0)
end

function die(drop)
  game_over=true
  sfx(2)
  if (drop) sfx(3)
end

function update_bird()
  if flapping then
    vy+=gravity
    if btnp(4) then
      flap()
    end
    bird_y+=vy
    if bird_y>106 then
      bird_y=106
      die(false)
    end
    wing=(wing+1)%3
  else
    bird_y=60+sin(t)*3
    t+=dt
    if (t>1.0) t-=1.0
    if btn(4) then
      flapping=true
      flap()
    end
  end
end

function new_pipe()
  return {
    x=128,
    y=8+rnd(48),
    p=false
  }
end

function update_pipes()
  if (not flapping) return
  if pipe_time > 0 then
    pipe_time-=1
  else
    add(pipes, new_pipe())
    pipe_time=30*2
  end
  for pipe in all(pipes) do
    pipe.x-=vx
    if pipe.x+pipe_width<bird_x and not pipe.p then
      score+=1
      pipe.p=true
      sfx(1)
    end
    if pipe.x<-32 then
      del(pipes, pipe)
    end
  end
end

function pipe_collision_x(pipe)
  if (pipe.x>bird_x+8) return false
  if (pipe.x+pipe_width<bird_x-8) return false
  return true
end

function pipe_collision_y(pipe)
  if (bird_y-6<pipe.y) return true
  if (bird_y+6>pipe.y+pipe_gap) return true
  return false
end

function pipe_collision(pipe)
  return pipe_collision_x(pipe) and
    pipe_collision_y(pipe)  
end

function check_pipe_collision()
  for pipe in all(pipes) do
    if pipe_collision(pipe) then
      die(true)
    end    
  end
end

function update_ground()
  ground_x-=vx
  if ground_x<-8 then
    ground_x+=8
  end
end

function _update()
  if game_over then
    update_bird_gravity()
    if btnp(5) then
      restart()
    end
  else
    update_bird()
    update_pipes()
    check_pipe_collision()
    update_ground()
  end
end

function draw_clouds()
  spr(64, 0, 64, 16, 2)
end

function draw_city()
  for i=0,4,1 do
    spr(7, i*35, 80, 5, 3)
  end
end

function draw_trees()
  spr(96, 0, 96, 16, 2)
end

function draw_bg()
  draw_clouds()
  draw_city()
  draw_trees()
end

function draw_ground()
  for i=0,16,1 do
    spr(2, ground_x+i*8, 112, 1, 2)
  end
end

function draw_pipes()
  for pipe in all(pipes) do
    for y=pipe.y-24,-7,-8 do
      spr(35, pipe.x, y, 4, 1)
    end
    for y=pipe.y+pipe_gap+16,112,8 do
      spr(35, pipe.x, y, 4, 1)
    end
    spr(3, pipe.x, pipe.y-16, 4, 2, false, true)
    spr(3, pipe.x, pipe.y+pipe_gap, 4, 2)
  end
end

function draw_bird()
  if game_over then
    spr(0, bird_x-8, bird_y-10, 2, 2, false, true)
    spr(32, bird_x-8, bird_y-5, 1, 1, false, true)
  else
    spr(0, bird_x-8, bird_y-6, 2, 2)
    spr(wing+32, bird_x-8, bird_y-3)
  end
end

function draw_score()
  str=tostr(score)
  x=56-(#str*8)/2
  for i=1,#str,1 do
    n=tonum(str[i])
    spr(128+n, x+i*8, 12, 1, 2)
  end
end

function _draw()
  cls(12)
  draw_bg()
  draw_pipes()
  draw_ground()
  draw_bird()
  if flapping then
    draw_score()
  end
end
__gfx__
00000555555000005555555555555555555555555555555555555555777777777777777777777777777666ccccc0000000000000000000000000000000000000
00005ffff57500007777777753333333333333333333333333333335777777777777777777777777777677c777c0000000000000000000000000000000000000
0005faaa57775000bb3333bb5b7bbbbbbbbbbbbbbbbbbbbbbb3b333577777777777777766666777777ccccc767c0000000000000000000000000000000000000
005faaaa56757500b3333bbb5b7bbbbbbbbbbbbbbbbbbbbbbb3b333577777777777776666666777777c7777777c0000000000000000000000000000000000000
05aaaaaa567575003333bbbb5b7bbbbbbbbbbbbbbbbbbbbbbb3b3335ccc777777777666666ccccccc7c7676767c0000000000000000000000000000000000000
05aaaaaaa5677500333333335b7bbbbbbbbbbbbbbbbbbbbbbb3b333567c777777776666666c77776c7c7676767c0000000000000000000000000000000000000
5aaaaaaaaa555550999999995b7bbbbbbbbbbbbbbbbbbbbbbb3b3335ccccccc77776666666c76776c7c7777777c0000000000000000000000000000000000000
5aaaaaaaa5888885ffffffff5b7bbbbbbbbbbbbbbbbbbbbbbb3b3335677777c66676666cccccccccc7c7676767c0000000000000000000000000000000000000
0599999958555550ffffffff5b7bbbbbbbbbbbbbbbbbbbbbbb3b3335677777c66676666c77777766c7c7676767c0000000000000000000000000000000000000
0059999995888850ffffffff5b7bbbbbbbbbbbbbbbbbbbbbbb3b3335676767c66676666c67676766c6c7777777c0000000000000000000000000000000000000
0005999999555500ffffffff5b7bbbbbbbbbbbbbbbbbbbbbbb3b3335676767c66676666c67676766c6c7777777c0000000000000000000000000000000000000
0000555555000000ffffffff5b7bbbbbbbbbbbbbbbbbbbbbbb3b3335677777c66676666c77777cccccc7676767c0000000000000000000000000000000000000
0000000000000000ffffffff5b7bbbbbbbbbbbbbbbbbbbbbbb3b3335676767c66676666c67676c7776c7676767c0000000000000000000000000000000000000
0000000000000000ffffffff5b7bbbbbbbbbbbbbbbbbbbbbbb3b3335676767c66666666c67676c7676c7777777c0000000000000000000000000000000000000
0000000000000000ffffffff53b77777777777777b7bbbbbbb3b3335677777c66666666c77777c7676c7676767c0000000000000000000000000000000000000
0000000000000000ffffffff55555555555555555555555555555555676767c66666666c67676c7776c7676767c0000000000000000000000000000000000000
00000000055550000000000005b7bbbbbbbbbbbbbbbbbbbbb3b33350676767c66666666c67676c7676c7777777c0000000000000000000000000000000000000
000000005ffff5000000000005b7bbbbbbbbbbbbbbbbbbbbb3b33350677777c66666666c77777c7676c7777777c0000000000000000000000000000000000000
055555505fffff500000000005b7bbbbbbbbbbbbbbbbbbbbb3b33350677777c66666666c77777c7776c7777777c0000000000000000000000000000000000000
5fffff505afffa500555550005b7bbbbbbbbbbbbbbbbbbbbb3b33350677777c66666666c77777c7776c7777777c0000000000000000000000000000000000000
5afffa5005aaa5005affff5005b7bbbbbbbbbbbbbbbbbbbbb3b33350677777c66666666c77777c7776c7777777c0000000000000000000000000000000000000
05555500005550005ffff50005b7bbbbbbbbbbbbbbbbbbbbb3b33350677777c66666666c77777c7776c7777777c0000000000000000000000000000000000000
00000000000000005ffa500005b7bbbbbbbbbbbbbbbbbbbbb3b33350677777c66666666c77777c7776c7777777c0000000000000000000000000000000000000
00000000000000000555500005b7bbbbbbbbbbbbbbbbbbbbb3b33350677777c66666666c77777c7776c7777777c0000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc77777cccccccccccccccccccccccccccccccc
cccccc77777cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc77777ccccccccccccc777777777cccccccccccccccccccccccccccccc
cccc777777777cccccccccccccccccccccccccccccccccccccccccccccccccccccccc7777777777ccccccccc777777777777cccccccccccccccccccccccccccc
cc7777777777777cccccccccccccccccccccccccc77777ccccccccccccccccccccc777777777777777ccccc77777777777777ccccccccccccccccccccccccccc
c777777777777777ccccccccccccccccccccccc777777777ccccccccccc77777cc7777777777777777777c777777777777777ccccc77777ccccccccccccccccc
77777777777777777cccccccccccccccccccc7777777777777ccccccc777777777777777777777777777777777777777777777cc777777777ccccccccccc7777
777777777777777777cccccccccccccccccc777777777777777cccc777777777777777777777777777777777777777777777777777777777777ccccccc777777
777777777777777777ccccccccccccccccc77777777777777777cc77777777777777777777777777777777777777777777777777777777777777cccc77777777
7777777777777777777ccccc77777ccccc77777777777777777777777777777777777777777777777777777777777777777777777777777777777cc777777777
7777777777777777777ccc777777777ccc7777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
00000000033330000000000033330000003333000000000003333000033330000000000000000033330000000000033330000003333000000000003333000033
000000033bbbb33000000033bbbb330033bbbb33000000033bbbb3333bbbb33000000000000033bbbb33000000033bbbb330033bbbb33000000033bbbb3333bb
0000033bbbbbbbb33003333bbbbbbb33bbbbbbbb33003333bbbbbbb33bbbbbb3300330000033bbbbbbbb33003333bbbbbbb33bbbbbbbb33003333bbbbbbb33bb
33303bbbbbbbbbb3333bbbb33bbbbbbb3bbb3333bb33bbbb33bbbbbbb3bbbb33333bb33303bbbbbbbbbbbb33bbbb33bbbbbbb3bbb3333bb33bbbb33bbbbbbb3b
bbb33bbbbbbbbbb33bbbbbbbb33bbbbb3b33bbbb33bbbbbbbb33bbbbb3bb33bbbbbbbbbb33bbbbbbbbbb33bbbbbbbb33bbbbb3b33bbbb33bbbbbbbb33bbbbb3b
bbbbb33bb3333b3bbbbbbbbbbbb3bbb3333bbbb3bbbbbbbbbbbb3bbbb3333bbbbbbbbbbbbb33bb3333b3bbbbbbbbbbbb3bbb3333bbbb3bbbbbbbbbbbb3bbbb33
bbbbbbb33bbbb33bbbbbbbbbbbb3b33bbbb33bb3bbbbbbbbbbbb3bb33bbbb33bbbbbbbbbbbbb33bbbb33bbbbbbbbbbbb3b33bbbb33bb3bbbbbbbbbbbb3bb33bb
bbbbb33bbbbbbbb33bbbbbbbbbb33bbbbbbbb33bbbbbbbbbbbbbb33bbbbbbbb33bbbbbbbbb33bbbbbbbb33bbbbbbbbbb33bbbbbbbb33bbbbbbbbbbbbbb33bbbb
bbbb3bbbbbbbbbbbb3bbbbbbbb3bbbbbbbbbbb3bbbbbbbbbbbbbb3bbbbbbbbbbb3bbbbbbb3bbbbbbbbbbbb3bbbbbbbb3bbbbbbbbbbb3bbbbbbbbbbbbbb3bbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
11111111011111001111111111111111111111111111111111111111111111111111111111111111000000000000000000000000000000000000000000000000
17777771017771001777777117777771177117711777777117777771177777711777777117777771000000000000000000000000000000000000000000000000
17777771017771001777777117777771177117711777777117777771177777711777777117777771000000000000000000000000000000000000000000000000
17711771011771001111177111111771177117711771111117711111111117711771177117711771000000000000000000000000000000000000000000000000
17711771001771001111177111111771177117711771111117711111000017711771177117711771000000000000000000000000000000000000000000000000
17711771001771001777777117777771177777711777777117777771000017711777777117777771000000000000000000000000000000000000000000000000
17711771001771001777777117777771177777711777777117777771000017711777777117777771000000000000000000000000000000000000000000000000
17711771001771001771111111111771111117711111177117711771000017711771177111111771000000000000000000000000000000000000000000000000
17711771001771001771111111111771000017711111177117711771000017711771177100001771000000000000000000000000000000000000000000000000
17777771001771001777777117777771000017711777777117777771000017711777777100001771000000000000000000000000000000000000000000000000
17777771001771001777777117777771000017711777777117777771000017711777777100001771000000000000000000000000000000000000000000000000
11111111001111001111111111111111000011111111111111111111000011111111111100001111000000000000000000000000000000000000000000000000
__sfx__
7e0118001763021630296402e6503065031660316603166031650306502e6402d6302b6302863025620216201d6201962015620116200d61009610056100161000610136101261011610106100e6100d6100b610
c00300002b5702b5702b5702b5702b5703f5703f5703f5703f5603f5603f5503f5503f5403f5403f5403f5403f5303f5303f5303f5303f5303f5203f5203f5203f5103f5103f5103f5003f5003f5003f5003f500
000100000b6500b6500b6500c6500c6500c6500c6500c6500c6500b6500b6500b6500c650196503f6503b6503765033650306502d6502965026650236501f6501c650196501665014650106500d6500b65008650
000200002775026750267502575025750247502475023750227502275021750207501f7501e7501d7501b7501a7501975017740167401474012740107300f7300d7200b7200a7200971008710087100771006710
